name: Release

on:
  push:
    branches:
      - main
    tags-ignore:
      - v*.*.*

jobs:
  check-api:
    env:
      # PORT: 8080
      RUN_SCHEDULED_SEARCHES: false
      MOCK_EXTRACTION: true
      MOCK_NOTIFICATION: true
      DB_TYPE: sqlite
      DB_DATABASE: gpm-test.db
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - run: cd api

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          cache: 'yarn'

      - name: Install dependencies
        run: yarn

      - name: Build
        run: yarn build

      - name: Lint
        run: yarn lint

      - name: Test
        run: yarn test

  check-client:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - run: cd client

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          cache: 'yarn'

      - name: Install dependencies
        run: yarn

      - name: Build
        run: yarn build

      - name: Lint
        run: yarn lint

      - name: Test
        run: yarn test

  release:
    needs: [check-api, check-client]
    runs-on: ubuntu-latest
    steps:
      - name: Set up Git
        run: |
          git config --global user.email "${GITHUB_ACTOR}"
          git config --global user.name "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Create client release
        run: |
          cd client
          yarn config set version-tag-prefix client-v
          yarn version --minor
          cd ..

      - name: Create api release
        run: |
          cd api
          yarn config set version-tag-prefix api-v
          yarn version --minor
          cd ..

      - name: Push release to git
        run: git push && git push --tags

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            export NVM_DIR=~/.nvm
            source ~/.nvm/nvm.sh
            /var/www/torvi/redeploy.sh
